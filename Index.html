<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Chess vs Gemini (One File)3</title>
  <!-- Chessboard UI -->
  <script type="module" src="https://unpkg.com/chessboard-element@4/dist/chessboard-element.js"></script>
  <!-- Chess rules engine -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, Rob-serif; background:#0f1115; color:#e8e8ea; margin:0; display:flex; flex-direction:column; align-items:center; }
    header { width:100%; padding:14px 18px; background:#13151a; border-bottom:1px solid #262a33; }
    main { display:flex; gap:24px; padding:24px; max-width:1000px; width:100%; box-sizing:border-box; }
    chess-board { width: 520px; max-width: 92vw; }
    #panel { flex:1; min-width:280px; }
    #log { background:#14171e; border:1px solid #262a33; border-radius:8px; padding:12px; height:280px; overflow:auto; font-size:14px; }
    #controls { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
    button { background:#1b1f2a; color:#e8e8ea; border:1px solid #2c3240; padding:8px 12px; border-radius:6px; cursor:pointer; }
    button:hover { background:#222836; }
    .row { margin-top:10px; font-size:14px; color:#b6bcc9; }
    input[type="password"], input[type="text"] { width:100%; padding:8px; border-radius:6px; border:1px solid #2c3240; background:#12151a; color:#e8e8ea; }
    footer { width:100%; padding:12px 18px; border-top:1px solid #262a33; background:#13151a; font-size:13px; color:#9aa3b6; }
    .tag { display:inline-block; padding:2px 8px; border:1px solid #2c3240; border-radius:999px; font-size:12px; color:#a9b0c0; margin-left:8px; }
  </style>
</head>
<body>
  <header>
    <strong>Chess vs Gemini</strong>
    <span class="tag">UCI JSON</span>
    <span class="tag">Client-only demo</span>
  </header>

  <main>
    <chess-board id="board" draggable-pieces></chess-board>
    <div id="panel">
      <div id="log"></div>

      <div id="controls">
        <button id="newGameBtn">New game</button>
        <button id="flipBtn">Flip</button>
        <button id="undoBtn">Undo</button>
      </div>

      <div class="row">
        <label for="apiKey"><strong>Gemini API key:</strong></label>
        <input id="apiKey" type="password" placeholder="Paste your key here" />
      </div>
      <div class="row">
        <label for="model"><strong>Model:</strong></label>
        <input id="model" type="text" value="gemini-1.5-flash" />
      </div>
      <div class="row" id="status"></div>
    </div>
  </main>

  <footer>
    Demo: chess.js + chessboard-element. The AI returns a single JSON object with a UCI move.
  </footer>

<script>
  // State
  const boardEl = document.getElementById('board');
  const logEl = document.getElementById('log');
  const statusEl = document.getElementById('status');
  const apiKeyInput = document.getElementById('apiKey');
  const modelInput = document.getElementById('model');
  const game = new Chess();
  let humanColor = 'white';
  let historySAN = [];

  // UI helpers
  function log(line) {
    const p = document.createElement('div');
    p.textContent = line;
    logEl.appendChild(p);
    logEl.scrollTop = logEl.scrollHeight;
  }
  function updateBoard() {
    boardEl.setPosition(game.fen(), true);
    const turn = game.turn() === 'w' ? 'White' : 'Black';
    statusEl.textContent = `Turn: ${turn} | FEN: ${game.fen()}`;
  }
  function resetGame() {
    game.reset();
    historySAN = [];
    updateBoard();
    log('New game started.');
    if (humanColor === 'black') requestAIMove(); // AI opens if you play Black
  }
  function undoPair() {
    const m1 = game.undo(); if (m1) historySAN.pop();
    const m2 = game.undo(); if (m2) historySAN.pop();
    updateBoard();
    log('Undid last pair of moves.');
  }

  // Drag guards (only move your pieces on your turn)
  boardEl.addEventListener('drag-start', (e) => {
    const { piece } = e.detail;
    const turn = game.turn() === 'w' ? 'white' : 'black';
    const pieceColor = piece.startsWith('w') ? 'white' : 'black';
    if (turn !== humanColor || pieceColor !== humanColor) e.preventDefault();
  });

  // Handle drops
  boardEl.addEventListener('drop', (e) => {
    const { source, target } = e.detail;
    const move = game.move({ from: source, to: target, promotion: 'q' });
    if (!move) return e.preventDefault(); // illegal
    historySAN.push(move.san);
    log(`You: ${move.san}`);
    updateBoard();

    if (game.isGameOver()) {
      log(game.isCheckmate() ? 'Checkmate!' : 'Game over.');
      return;
    }
    requestAIMove();
  });

  // Controls
  document.getElementById('newGameBtn').onclick = resetGame;
  document.getElementById('flipBtn').onclick = () => {
    boardEl.flip();
    humanColor = humanColor === 'white' ? 'black' : 'white';
    log(`You are now playing as ${humanColor}.`);
    resetGame();
  };
  document.getElementById('undoBtn').onclick = undoPair;

  // Gemini request
  async function requestAIMove() {
    const apiKey = apiKeyInput.value.trim();
    const model = modelInput.value.trim() || 'gemini-1.5-flash';
    if (!apiKey) {
      log('Error: Paste your Gemini API key.');
      return;
    }

    const prompt = `
You are a chess engine assistant. Respond ONLY with one JSON object:
{"move":"e2e4","reason":"...","confidence":0.7}
Rules:
- "move" must be a legal UCI move for the provided FEN.
- Use lowercase; include promotion like "a7a8q" if needed.
Input:
- FEN: ${game.fen()}
- Side to move: ${game.turn()==='w'?'white':'black'}
- History (SAN): ${historySAN.join(', ') || '(none)'}
Examples:
{"move":"g1f3","reason":"Develop knight","confidence":0.68}
{"move":"a7a8q","reason":"Promote to queen","confidence":0.90}
`;

    statusEl.textContent = 'Thinking...';
    try {
      const resp = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(model)}:generateContent?key=${encodeURIComponent(apiKey)}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ role: 'user', parts: [{ text: prompt }] }],
            generationConfig: { temperature: 0.3, topK: 40, topP: 0.95, maxOutputTokens: 64 }
          })
        }
      );

      const data = await resp.json();
      const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
      if (!text) throw new Error('Empty response from model.');

      // Extract JSON robustly
      const match = text.match(/\{[\s\S]*\}/);
      if (!match) throw new Error('Model did not return JSON.');
      let parsed;
      try { parsed = JSON.parse(match[0]); } catch { throw new Error('Invalid JSON from model.'); }

      const uci = String(parsed.move || '').toLowerCase();
      if (!uci || uci.length < 4) throw new Error('Invalid move field.');

      const move = game.move({
        from: uci.slice(0, 2),
        to: uci.slice(2, 4),
        promotion: uci.length === 5 ? uci[4] : undefined
      });

      if (!move) throw new Error(`Illegal AI move: ${uci}`);

      historySAN.push(move.san);
      log(`Gemini: ${move.san} (${parsed.reason ?? 'no reason'})`);
      statusEl.textContent = `Confidence: ${parsed.confidence ?? 'n/a'}`;
      updateBoard();

      if (game.isGameOver()) log(game.isCheckmate() ? 'Checkmate!' : 'Game over.');
    } catch (err) {
      statusEl.textContent = '';
      log(`Error: ${err.message}`);
      console.error(err);
    }
  }

  // Init
  updateBoard();
</script>
</body>
</html>
